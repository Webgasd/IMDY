<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.upc.dao.ExamTrainCaMaterialMapper">
  <resultMap id="BaseResultMap" type="com.example.upc.dataobject.ExamTrainCaMaterial">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Apr 29 10:58:28 CST 2019.
    -->
    <id column="id" jdbcType="INTEGER" property="id" />
    <result column="ca_id" jdbcType="INTEGER" property="caId" />
    <result column="course_id" jdbcType="INTEGER" property="courseId" />
    <result column="train_material_id" jdbcType="INTEGER" property="trainMaterialId" />
    <result column="completion_rate" jdbcType="REAL" property="completionRate" />
    <result column="start_time" jdbcType="TIMESTAMP" property="startTime" />
    <result column="end_time" jdbcType="TIMESTAMP" property="endTime" />
    <result column="operator" jdbcType="VARCHAR" property="operator" />
    <result column="operate_time" jdbcType="TIMESTAMP" property="operateTime" />
    <result column="operate_ip" jdbcType="VARCHAR" property="operateIp" />
  </resultMap>
  <resultMap id="PersonParamMap" type="com.example.upc.controller.param.TrainPersonParam">
    <id column="id" jdbcType="INTEGER" property="id" />
    <result column="name" jdbcType="VARCHAR" property="name" />
    <result column="id_number" jdbcType="VARCHAR" property="idNumber" />
    <result column="telephone" jdbcType="VARCHAR" property="telephone" />
    <result column="sexy" jdbcType="INTEGER" property="sexy" />
    <result column="industry" jdbcType="INTEGER" property="industry" />
    <result column="work_type" jdbcType="INTEGER" property="workType" />
    <result column="company_name" jdbcType="VARCHAR" property="companyName" />
    <result column="photo" jdbcType="VARCHAR" property="photo" />
    <result column="electronic_number" jdbcType="VARCHAR" property="electronicNumber" />
    <result column="train_id" jdbcType="VARCHAR" property="trainId" />
    <result column="train_name" jdbcType="VARCHAR" property="trainName" />
    <result column="completion_rate" jdbcType="REAL" property="completionRate" />
  </resultMap>
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Apr 29 10:58:28 CST 2019.
    -->
    id, ca_id,course_id,train_material_id, completion_rate, start_time, end_time, operator, operate_time,
    operate_ip
  </sql>

  <delete id="deleteByCaId" parameterType="int">
    DELETE FROM exam_train_ca_material
    WHERE ca_id = #{caId}
    AND course_id = #{courseId}
  </delete>

  <insert id="batchInsert" parameterType="map">
    insert into exam_train_ca_material (ca_id,course_id,train_material_id,completion_rate ,start_time,end_time,operator, operate_time, operate_ip)
    values
    <foreach collection="caMaterialList" item="caMaterial" separator=",">
      ( #{caMaterial.caId},#{caMaterial.courseId}, #{caMaterial.trainMaterialId},#{caMaterial.completionRate},#{caMaterial.startTime},#{caMaterial.endTime}, #{caMaterial.operator}, #{caMaterial.operateTime}, #{caMaterial.operateIp})
    </foreach>
  </insert>

  <select id="countList" resultType="int">
    SELECT count(1) FROM (
    <if test="search.completion != null ">SELECT * FROM (</if>
    SELECT a.* FROM
    (SELECT a.*,b.name as train_name,b.id as train_id FROM
    (SELECT a.id,b.name,b.id_number,b.telephone,b.sexy,b.industry,b.work_type,b.company_name,b.photo,b.electronic_number
    FROM sys_user as a INNER JOIN supervision_ca as b on a.info_id = b.id where a.user_type = 3
    <if test="search.caName != null and search.caName != ''">AND b.name LIKE CONCAT('%',#{search.caName},'%')</if>
    <if test="search.companyName != null and search.companyName != ''">AND b.company_name LIKE
      CONCAT('%',#{search.companyName},'%')</if>) as a
    LEFT JOIN exam_train_course as b on a.work_type=b.worktype ) as a
    LEFT JOIN exam_train_ca_material as b on a.id = b.ca_id and a.train_id = b.course_id GROUP BY a.id,a.train_id
    <if test="search.completion == 1 ">)as a WHERE a.completion_rate = 1</if>
    <if test="search.completion == 2 ">)as a WHERE a.completion_rate != 1 OR a.completion_rate IS NULL </if>) as a
  </select>

  <select id="getPage" resultMap="PersonParamMap">
    <if test="search.completion != null ">SELECT * FROM (</if>
    SELECT a.*, SUM(b.completion_rate)/count(1) as completion_rate FROM
    (SELECT a.*,b.name as train_name,b.id as train_id FROM
    (SELECT a.id,b.name,b.id_number,b.telephone,b.sexy,b.industry,b.work_type,b.company_name,b.photo,b.electronic_number
    FROM sys_user as a INNER JOIN supervision_ca as b on a.info_id = b.id where a.user_type = 3
    <if test="search.caName != null and search.caName != ''">AND b.name LIKE CONCAT('%',#{search.caName},'%')</if>
    <if test="search.companyName != null and search.companyName != ''">AND b.company_name LIKE
      CONCAT('%',#{search.companyName},'%')</if>) as a
    LEFT JOIN exam_train_course as b on a.work_type=b.worktype limit #{page.offset}, #{page.pageSize}) as a
    LEFT JOIN exam_train_ca_material as b on a.id = b.ca_id and a.train_id = b.course_id GROUP BY a.id,a.train_id
    <if test="search.completion == 1 ">)as a WHERE a.completion_rate = 1</if>
    <if test="search.completion == 2 ">)as a WHERE a.completion_rate != 1 OR a.completion_rate IS NULL </if>
  </select>

</mapper>